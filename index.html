<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Cesium Drawing</title>
  <script src="Cesium/Cesium/Cesium.js"></script>
  <script src="js/jquery-3.1.1.min.js"></script>
  <style>
    @import url(Cesium/Cesium/Widgets/widgets.css);
      html, body, #cesiumContainer {
        position: absolute;
        width: 100%;
        bottom: 0px;
        top: 0px;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      .toolbar {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: #ffffff;
      }

      .toolbar > .button {
        cursor: pointer;
        padding: 2px;
      }

      .toolbar > .button:hover {
        background: #eee;
      }


  </style>
</head>
<body>

    <div id="cesiumContainer"></div>

    <div class="toolbar">
      <div id="drawPolyline" class="button">
          <span><img src="img/drawPolyline.png"></img></span>
      </div>
      <div id="drawPolygon" class="button">
          <span><img src="img/drawPolygon.png"></img></span>
      </div>
      <div id="drawExtrudedPolygon" class="button">
          <span><img src="img/drawExtrudedPolygon.png"></img></span>
      </div>
      <div id="drawCircle" class="button">
          <span><img src="img/drawCircle.png"></img></span>
      </div>
    </div>

    <script>

    var viewer = new Cesium.Viewer('cesiumContainer');

    // Disable the default entity double click action.
    viewer.screenSpaceEventHandler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

    function createPositionsHandler(positions) {

      var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

      var draggers = [];

      // Adds a point to the positions list.
      handler.lastPointTemporary = false;
      handler.setInputAction(function(movement) {
          var cartesian = viewer.camera.pickEllipsoid(movement.position, viewer.scene.globe.ellipsoid);
          if (cartesian) {
            if (handler.lastPointTemporary)
            {
                positions.pop();
            }
            var index = positions.length;
            positions.push( cartesian );
            var dragger = createDragger( cartesian, function(dragger, position) {
                dragger.positions[dragger.index] = position;
            });
            dragger.index = index;
            dragger.positions = positions;
            draggers.push( dragger );

            handler.lastPointTemporary = false;
          }
      }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

      // Replaces the last point in the list with the point under the mouse.
      handler.setInputAction(function(movement) {
        if (movement.endPosition) {
            var cartesian = viewer.camera.pickEllipsoid(movement.endPosition, viewer.scene.globe.ellipsoid);
            if (cartesian) {
              if (handler.lastPointTemporary)
              {
                positions.pop();
              }
              positions.push( cartesian );
              handler.lastPointTemporary = true;
            }
          }
      }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

      handler.setInputAction(function(movement) {
          handler.destroy();
          // Get rid of all the draggers.
          /*
          for (var i = 0; i < draggers.length; i++) {
            viewer.entities.remove( draggers[i]);
          }
          draggers = [];
          */
      }, Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK);

      return handler;
    }


    function drawPolyline() {

      // The list of positions to modify.
      var positions = [];

      // Create the entity
      var entity = viewer.entities.add({
          name : 'Entity',
          polyline : {
              // We need to use a callback property to ensure that this geometry is not built in a web worker
              // so we can update it on the fly.
              positions : new Cesium.CallbackProperty(function(time, result) {
                return positions;
              }),
              width : 2,
              material : Cesium.Color.RED
          }
      });

      createPositionsHandler( positions );
    }

    function drawPolygon() {

      // The list of positions to modify.
      var positions = [];

      // Create the entity
      var entity = viewer.entities.add({
          name : 'Entity',
          polygon : {
            hierarchy : new Cesium.CallbackProperty(function(time, result) {
                return positions;
            }),
            material : Cesium.Color.RED
          }
      });

      createPositionsHandler( positions );
    }

    function drawExtrudedPolygon() {

      // The list of positions to modify.
      var positions = [];

      // Create the entity
      var entity = viewer.entities.add({
          name : 'Entity',
          polygon : {
            hierarchy : new Cesium.CallbackProperty(function(time, result) {
              return positions;
            }),
            extrudedHeight: 50000,
            perPositionHeight : true,
            material : Cesium.Color.ORANGE.withAlpha(0.5),
            outline : true,
            outlineColor : Cesium.Color.BLACK
        }
      });

      createPositionsHandler( positions );
    }

    function drawCircle() {

      var position = Cesium.Cartesian3.fromDegrees(-103.0, 40.0);

      // Create an ellipse.
      // Should really wait for the first click.
      var entity = viewer.entities.add({
        position: new Cesium.CallbackProperty(function(time, result) {
          return position;
        }),
        name : 'Entity',
        ellipse : {
            semiMinorAxis : 300000.0,
            semiMajorAxis : 300000.0,
            material : Cesium.Color.GREEN.withAlpha(0.5),
            outline : true,
            outlineColor : Cesium.Color.BLACK
        }
      });

      // Create a dragger that just modifies the entities position.
      createDragger(position, function(dragger, newPosition) {
        position = newPosition;
      });
    }

    function createDragger(position, onDrag) {
       var dragger = viewer.entities.add({
          position : position,
          billboard :{
              image : "img/dragIcon.png"
          }
      });
      dragger._isDragger = true;
      dragger.onDrag = onDrag;
      return dragger;
    }

    var draggerHandler = new Cesium.ScreenSpaceEventHandler(viewer.canvas);
    draggerHandler.dragger = null;

    draggerHandler.setInputAction(
        function(click) {
            var pickedObject = viewer.scene.pick(click.position);
            if (Cesium.defined(pickedObject)) {
                var entity = pickedObject.id;
                if (Cesium.defaultValue(entity._isDragger, false)) {
                  entity.billboard.scale = 1.2;
                  draggerHandler.dragger = entity;
                  viewer.scene.screenSpaceCameraController.enableRotate = false;
                }
            }
        },
        Cesium.ScreenSpaceEventType.LEFT_DOWN
    );

    draggerHandler.setInputAction(
        function(movement) {
            if (draggerHandler.dragger) {
              var hit = viewer.camera.pickEllipsoid(movement.endPosition);
                if (hit) {
                  draggerHandler.dragger.position = hit;
                  if (draggerHandler.dragger.onDrag) {
                    draggerHandler.dragger.onDrag(draggerHandler.dragger, hit);
                  }
                }
            }
        },
        Cesium.ScreenSpaceEventType.MOUSE_MOVE
    );

    draggerHandler.setInputAction(
        function() {
            if (draggerHandler.dragger) {
              draggerHandler.dragger.billboard.scale = 1;
              draggerHandler.dragger = null;
              viewer.scene.screenSpaceCameraController.enableRotate = true;
            }
        },
        Cesium.ScreenSpaceEventType.LEFT_UP
    );

    $(function() {
      $("#drawPolyline").click(function() {
        drawPolyline();
      });

      $("#drawPolygon").click(function() {
        drawPolygon();
      });

      $("#drawExtrudedPolygon").click(function() {
        drawExtrudedPolygon();
      });

      $("#drawCircle").click(function() {
        drawCircle();
      });

    });

    </script>

</body>
</html>


